@page "/order-tracking"
@model GadgetHubWeb.Pages.OrderTrackingModel
@{
    ViewData["Title"] = "Order Tracking";
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-truck"></i> Order Tracking
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Order Number Input -->
                    <div class="mb-4">
                        <label for="orderNumber" class="form-label">Enter your order number:</label>
                        <div class="input-group">
                            <input type="text" id="orderNumber" class="form-control" placeholder="e.g., GH-20251019-C78583C3" />
                            <button class="btn btn-primary" onclick="trackOrder()">
                                <i class="fas fa-search"></i> Track Order
                            </button>
                        </div>
                    </div>

                    <!-- Loading Spinner -->
                    <div id="loadingSpinner" class="text-center" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Tracking your order...</p>
                    </div>

                    <!-- Notification Status -->
                    <div id="notificationStatus" class="alert alert-info" style="display: none;">
                        <i class="fas fa-bell"></i> <span id="notificationText"></span>
                    </div>

                    <!-- Order Tracking Results -->
                    <div id="trackingResults" style="display: none;">
                        <!-- Order Summary -->
                        <div class="card mb-3">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-check-circle"></i> Order Confirmed
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>Order Number:</strong> <span id="displayOrderNumber"></span></p>
                                        <p><strong>Order Date:</strong> <span id="displayOrderDate"></span></p>
                                        <p><strong>Total Amount:</strong> <span id="displayTotalAmount"></span></p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>Status:</strong> <span id="displayStatus" class="badge bg-success"></span></p>
                                        <p><strong>Customer:</strong> <span id="displayCustomerName"></span></p>
                                        <p><strong>Email:</strong> <span id="displayCustomerEmail"></span></p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Delivery Information -->
                        <div class="card mb-3">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-shipping-fast"></i> Delivery Information
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>Estimated Delivery:</strong> <span id="displayDeliveryDate"></span></p>
                                        <p><strong>Delivery Time:</strong> <span id="displayDeliveryDays"></span> days</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>Processing By:</strong> <span id="displayDistributors"></span></p>
                                    </div>
                                </div>
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i> <span id="displayMessage"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Detailed Delivery Information -->
                        <div class="card">
                            <div class="card-header bg-warning text-dark">
                                <h5 class="mb-0">
                                    <i class="fas fa-list-alt"></i> Detailed Delivery Information
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="deliveryDetails">
                                    <!-- Dynamic delivery details will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Error Message -->
                    <div id="errorMessage" class="alert alert-danger" style="display: none;">
                        <i class="fas fa-exclamation-triangle"></i> <span id="errorText"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
async function trackOrder() {
    const orderNumber = document.getElementById('orderNumber').value.trim();
    
    if (!orderNumber) {
        showError('Please enter an order number.');
        return;
    }

    // Show loading spinner
    showLoading(true);
    hideResults();
    hideError();
    hideNotification();

    try {
        // First check for customer notifications (distributor order IDs)
        const notificationResponse = await fetch(`https://localhost:7091/api/QuotationManagement/customer-notifications/${orderNumber}`);
        let hasNotifications = false;
        
        if (notificationResponse.ok) {
            const notificationData = await notificationResponse.json();
            if (notificationData.success) {
                hasNotifications = true;
                showNotification('ðŸŽ‰ Your order has been confirmed with distributors! Check the details below.');
            } else {
                showNotification('â³ Your order is still being processed. Admin will confirm distributors shortly.');
            }
        }

        // Then get order tracking details
        const response = await fetch(`https://localhost:7091/api/QuotationManagement/order-tracking/${orderNumber}`);
        
        if (response.ok) {
            const data = await response.json();
            displayTrackingResults(data, hasNotifications);
        } else if (response.status === 404) {
            showError('Order not found. Please check your order number and try again.');
        } else {
            showError('Error tracking order. Please try again later.');
        }
    } catch (error) {
        console.error('Error tracking order:', error);
        showError('Network error. Please check your connection and try again.');
    } finally {
        showLoading(false);
    }
}

function displayTrackingResults(data, hasNotifications = false) {
    // Update order summary
    document.getElementById('displayOrderNumber').textContent = data.orderNumber;
    document.getElementById('displayOrderDate').textContent = data.orderDate;
    document.getElementById('displayTotalAmount').textContent = `LKR ${data.totalAmount.toLocaleString()}`;
    document.getElementById('displayStatus').textContent = data.status;
    document.getElementById('displayCustomerName').textContent = data.customerName;
    document.getElementById('displayCustomerEmail').textContent = data.customerEmail;

    // Update delivery information
    document.getElementById('displayDeliveryDate').textContent = data.estimatedDeliveryDate;
    document.getElementById('displayDeliveryDays').textContent = data.estimatedDeliveryDays;
    document.getElementById('displayDistributors').textContent = data.confirmedDistributors.join(', ');
    document.getElementById('displayMessage').textContent = data.message;

    // Update detailed delivery information
    const deliveryDetailsContainer = document.getElementById('deliveryDetails');
    deliveryDetailsContainer.innerHTML = '';

    if (data.deliveryInfo && data.deliveryInfo.length > 0) {
        data.deliveryInfo.forEach(item => {
            const deliveryCard = document.createElement('div');
            deliveryCard.className = 'card mb-2';
            deliveryCard.innerHTML = `
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <strong>${item.distributor}</strong>
                        </div>
                        <div class="col-md-3">
                            <span class="badge bg-primary">Order ID: ${item.distributorOrderId}</span>
                        </div>
                        <div class="col-md-3">
                            ${item.productName} (Qty: ${item.quantity})
                        </div>
                        <div class="col-md-3">
                            <strong>Delivery: ${item.deliveryDate}</strong>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-6">
                            <small class="text-muted">Unit Price: LKR ${item.unitPrice.toLocaleString()}</small>
                        </div>
                        <div class="col-md-6">
                            <small class="text-muted">Total: LKR ${item.totalPrice.toLocaleString()}</small>
                        </div>
                    </div>
                </div>
            `;
            deliveryDetailsContainer.appendChild(deliveryCard);
        });
    } else {
        deliveryDetailsContainer.innerHTML = '<p class="text-muted">No detailed delivery information available.</p>';
    }

    showResults();
}

function showLoading(show) {
    document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
}

function showResults() {
    document.getElementById('trackingResults').style.display = 'block';
}

function hideResults() {
    document.getElementById('trackingResults').style.display = 'none';
}

function showError(message) {
    document.getElementById('errorText').textContent = message;
    document.getElementById('errorMessage').style.display = 'block';
}

function hideError() {
    document.getElementById('errorMessage').style.display = 'none';
}

function showNotification(message) {
    document.getElementById('notificationText').textContent = message;
    document.getElementById('notificationStatus').style.display = 'block';
}

function hideNotification() {
    document.getElementById('notificationStatus').style.display = 'none';
}

// Allow Enter key to trigger tracking
document.getElementById('orderNumber').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        trackOrder();
    }
});
</script>

<style>
.card {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border: none;
}

.card-header {
    border-bottom: none;
}

.badge {
    font-size: 0.875em;
}

.alert {
    border: none;
    border-radius: 0.5rem;
}

.spinner-border {
    width: 3rem;
    height: 3rem;
}

.form-control:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.btn-primary {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.btn-primary:hover {
    background-color: #0b5ed7;
    border-color: #0a58ca;
}
</style>
