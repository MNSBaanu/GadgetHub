@page
@model GadgetHubWeb.Pages.CheckoutModel
@{
    ViewData["Title"] = "Checkout";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - GadgetHub</title>
    <link rel="stylesheet" href="~/css/checkout.css" />
    <link rel="icon" type="image/x-icon" href="~/assets/favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="~/js/auth.js"></script>
</head>
<body>
    <!-- Header / Navbar -->
    <header class="header">
        <div class="logo">
            <img src="~/assets/logo.png" alt="GadgetHub Logo" />
            <span>GadgetHub</span>
        </div>
        <button class="hamburger" id="hamburger">
            <span></span>
            <span></span>
            <span></span>
        </button>
        <nav class="nav" id="nav">
            <a href="/Index">Home</a>
            <a href="/Products">Products</a>
            <a href="/Contact">Contact</a>
            <a href="/Cart" class="cart-link">
                <i class="fas fa-shopping-cart"></i>
                <span class="cart-count" id="cartCount" style="display: none;">0</span>
            </a>
            <div class="user-profile-nav" id="userProfileNav" style="display: none; align-items: center; gap: 0.75rem; margin-left: 0.5rem;">
                <a href="/Dashboard" class="user-avatar-link" style="text-decoration: none; display: flex !important; width: 32px; height: 32px; background: #1a1a1a; border-radius: 50%; align-items: center; justify-content: center; border: 2px solid #1a1a1a; transition: all 0.3s ease; cursor: pointer;" id="userAvatar">
                    <span class="avatar-initials" id="avatarInitials" style="color: white; font-size: 0.75rem; font-weight: 700; font-family: 'Inter', sans-serif;">U</span>
                </a>
            </div>
            <div class="admin-profile-nav" id="adminProfileNav" style="display: none; align-items: center; gap: 0.75rem; margin-left: 0.5rem;">
                <a href="/AdminDashboard" class="admin-avatar-link" style="text-decoration: none; display: flex !important; width: 32px; height: 32px; background: #1a1a1a; border-radius: 50%; align-items: center; justify-content: center; border: 2px solid #1a1a1a; transition: all 0.3s ease; cursor: pointer;" id="adminAvatar">
                    <span class="avatar-initials" id="adminAvatarInitials" style="color: white; font-size: 0.75rem; font-weight: 700; font-family: 'Inter', sans-serif;">A</span>
                </a>
            </div>
            <a href="/Login" class="login-link" id="loginLink" style="display: none;">
                <i class="fas fa-sign-in-alt"></i>
            </a>
        </nav>
    </header>

    <!-- Checkout Page Content -->
    <div class="checkout-page">
        <div class="container">
            <!-- Error Message Container -->
            <div id="errorMessage" class="error-message" style="display: none;">
                <div class="error-content">
                    <span class="error-icon">??</span>
                    <span class="error-text"></span>
                    <button class="error-close" onclick="hideError()">ÔøΩ</button>
                </div>
            </div>

            <!-- Checkout Content -->
            <div class="checkout-content">
                <!-- Left Side: Shipping Information -->
                <div class="left-column">
                    <div class="shipping-section">
                        <h3>Shipping Information</h3>
                        <form id="shippingForm">
                            <div class="form-group">
                                <label for="firstName">First Name</label>
                                <input type="text" id="firstName" name="firstName" required>
                            </div>
                            <div class="form-group">
                                <label for="lastName">Last Name</label>
                                <input type="text" id="lastName" name="lastName" required>
                            </div>
                            <div class="form-group">
                                <label for="email">Email</label>
                                <input type="email" id="email" name="email" required>
                            </div>
                            <div class="form-group">
                                <label for="phone">Phone Number</label>
                                <input type="tel" id="phone" name="phone" required>
                            </div>
                            <div class="form-group">
                                <label for="address">Address</label>
                                <textarea id="address" name="address" rows="3" required></textarea>
                            </div>
                            <div class="form-group">
                                <label for="city">City</label>
                                <input type="text" id="city" name="city" required>
                            </div>
                            <div class="form-group">
                                <label for="country">Country</label>
                                <input type="text" id="country" name="country" value="Sri Lanka" readonly>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Right Side: Order Summary & Payment -->
                <div class="right-column">
                    <!-- Order Summary -->
                    <div class="order-summary">
                        <h3>Order Summary</h3>
                        <div class="summary-items" id="summaryItems">
                            <!-- Items will be loaded here -->
                        </div>
                        <div class="summary-totals">
                            <div class="summary-row">
                                <span>Subtotal:</span>
                                <span id="subtotal">LKR 0</span>
                            </div>
                            <div class="summary-row total">
                                <span>Total:</span>
                                <span id="total">LKR 0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Method Section -->
                    <div class="payment-section">
                        <h3>Payment Method</h3>
                        <div class="payment-options">
                            <div class="payment-option">
                                <input type="radio" id="cashOnDelivery" name="paymentMethod" value="cashOnDelivery" checked required>
                                <label for="cashOnDelivery" class="payment-label">
                                    <div class="payment-icon">üí∞</div>
                                    <div class="payment-info">
                                        <span class="payment-name">Cash on Delivery</span>
                                        <span class="payment-desc">Pay when you receive your order</span>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Complete Order Button -->
                    <div class="checkout-actions">
                        <button type="button" class="checkout-btn" onclick="completeOrder()">Complete Order</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-section">
                <h3>GadgetHub</h3>
                <p>Your gateway to the latest technology. Discover, compare, and shop the best gadgets from trusted distributors.</p>
            </div>
            <div class="footer-section">
                <h4>Quick Links</h4>
                <ul>
                    <li><a href="/Products">Products</a></li>
                    <li><a href="/Contact">Contact</a></li>
                    <li><a href="/About">About Us</a></li>
                    <li><a href="/Support">Support</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h4>Connect With Us</h4>
                <div class="socials">
                    <a href="#" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                    <a href="#" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
                    <a href="#" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                    <a href="#" aria-label="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2025 GadgetHub. All rights reserved.</p>
        </div>
    </footer>

    <script>
        // Global variables
        let currentCartItems = [];
        let currentTotals = {};

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Update navigation
            updateNavigation();
            
            // Check if admin is logged in and disable checkout
            if (isAdminLoggedIn()) {
                const checkoutBtn = document.querySelector('.checkout-btn');
                if (checkoutBtn) {
                    checkoutBtn.disabled = true;
                    checkoutBtn.textContent = 'Admin Cannot Place Orders';
                    checkoutBtn.style.backgroundColor = '#ccc';
                    checkoutBtn.style.cursor = 'not-allowed';
                }
                
                // Show admin notice
                const checkoutActions = document.querySelector('.checkout-actions');
                if (checkoutActions) {
                    const adminNotice = document.createElement('div');
                    adminNotice.className = 'admin-notice';
                    adminNotice.innerHTML = '<i class="fas fa-info-circle"></i> Admin users cannot place orders. Please log out and use a customer account.';
                    adminNotice.style.cssText = 'background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 12px; border-radius: 6px; margin-top: 10px; font-size: 14px; display: flex; align-items: center; gap: 8px;';
                    checkoutActions.appendChild(adminNotice);
                }
            }
            
            // Hamburger menu functionality
            const hamburger = document.getElementById('hamburger');
            const nav = document.getElementById('nav');

            hamburger.addEventListener('click', function() {
                hamburger.classList.toggle('active');
                nav.classList.toggle('active');
            });

            // Close menu when clicking on a link
            nav.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    hamburger.classList.remove('active');
                    nav.classList.remove('active');
                }
            });

            // Close menu when clicking outside
            document.addEventListener('click', function(e) {
                if (!hamburger.contains(e.target) && !nav.contains(e.target)) {
                    hamburger.classList.remove('active');
                    nav.classList.remove('active');
                }
            });

            // Load order summary
            loadOrderSummary();
            updateCartCounter();
            
            // Check login status and update UI
            checkLoginStatus();
            
            // Redirect to login if not logged in and no items in cart
            const sessionId = localStorage.getItem('sessionId');
            const cartItems = JSON.parse(localStorage.getItem('cartItems')) || [];
            
            if (!sessionId && cartItems.length === 0) {
                showError('Please login and add items to cart before checkout');
                setTimeout(() => {
                    window.location.href = '/Login';
                }, 3000);
            }

            // Listen for storage changes (when cart is updated from another tab)
            window.addEventListener('storage', function(e) {
                if (e.key === 'cartItems') {
                    loadOrderSummary();
                    updateCartCounter();
                }
            });

            // Refresh cart when page becomes visible (user returns from cart page)
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden) {
                    loadOrderSummary();
                    updateCartCounter();
                }
            });
        });

        // Load order summary from cart
        function loadOrderSummary() {
            console.log('=== LOADING ORDER SUMMARY ===');

            // Get cart items from localStorage
            currentCartItems = JSON.parse(localStorage.getItem('cartItems')) || [];
            console.log('Cart items:', currentCartItems);

            const summaryItems = document.getElementById('summaryItems');

            if (currentCartItems.length === 0) {
                console.log('No items in cart');
                summaryItems.innerHTML = `
                    <div class="empty-cart-container">
                        <div class="empty-cart-icon">üõí</div>
                        <h3 class="empty-cart-title">Your cart is empty</h3>
                        <p class="empty-cart-description">Add some amazing gadgets to get started with your order!</p>
                        <div class="empty-cart-actions">
                            <a href="/Cart" class="empty-cart-button">
                                <i class="fas fa-shopping-cart"></i>
                                Go to Cart
                            </a>
                            <a href="/Products" class="empty-cart-button secondary">
                                <i class="fas fa-search"></i>
                                Browse Products
                            </a>
                        </div>
                    </div>
                `;
                updateTotals(0, 0, 0, 0);
                
                // Disable checkout button when no items
                const checkoutBtn = document.querySelector('.checkout-btn');
                if (checkoutBtn) {
                    checkoutBtn.disabled = true;
                    checkoutBtn.textContent = 'Add Items to Cart First';
                    checkoutBtn.style.backgroundColor = '#ccc';
                    checkoutBtn.style.cursor = 'not-allowed';
                }
                
                return;
            }

            // Display cart items
            summaryItems.innerHTML = '';
            currentCartItems.forEach((item, index) => {
                const itemTotal = (item.price || 0) * (item.quantity || 0);
                console.log(`Item ${index}: ${item.name} - LKR ${itemTotal}`);

                const itemElement = document.createElement('div');
                itemElement.className = 'summary-item';
                itemElement.innerHTML = `
                    <div class="item-info">
                        <span class="item-name">${item.name}</span>
                        <span class="item-quantity">Qty: ${item.quantity}</span>
                    </div>
                    <span class="item-price">LKR ${(itemTotal || 0).toLocaleString()}</span>
                `;
                summaryItems.appendChild(itemElement);
            });

            // Enable checkout button when items are present
            const checkoutBtn = document.querySelector('.checkout-btn');
            if (checkoutBtn) {
                checkoutBtn.disabled = false;
                checkoutBtn.textContent = 'Complete Order';
                checkoutBtn.style.backgroundColor = '';
                checkoutBtn.style.cursor = '';
            }

            // Show success message if items were just added
            if (currentCartItems.length > 0) {
                showSuccessMessage(`Great! You have ${currentCartItems.length} item${currentCartItems.length > 1 ? 's' : ''} in your cart. Ready to checkout!`);
            }

            // Calculate totals
            calculateTotals();
        }

        // Calculate totals from cart items
        function calculateTotals() {
            let subtotal = 0;
            currentCartItems.forEach(item => {
                const itemPrice = parseFloat(item.price) || 0;
                const itemQuantity = parseInt(item.quantity) || 0;
                subtotal += itemPrice * itemQuantity;
            });

            // No shipping or tax - just use subtotal as total
            const total = subtotal;

            currentTotals = { subtotal, shipping: 0, tax: 0, total };

            console.log('Calculated totals:', currentTotals);
            updateTotals(subtotal, 0, 0, total);
        }

        // Update totals display
        function updateTotals(subtotal, shipping, tax, total) {
            console.log('Updating totals display:', { subtotal, shipping, tax, total });

            const subtotalElement = document.getElementById('subtotal');
            const totalElement = document.getElementById('total');

            if (subtotalElement) subtotalElement.textContent = `LKR ${(subtotal || 0).toLocaleString()}`;
            if (totalElement) totalElement.textContent = `LKR ${(total || 0).toLocaleString()}`;
        }

        // Update cart counter
        function updateCartCounter() {
            const cartItems = JSON.parse(localStorage.getItem('cartItems')) || [];
            const totalItems = cartItems.reduce((sum, item) => sum + item.quantity, 0);
            const cartCount = document.getElementById('cartCount');

            if (totalItems > 0) {
                cartCount.textContent = totalItems;
                cartCount.style.display = 'inline-block';
            } else {
                cartCount.style.display = 'none';
            }
        }

        // Check login status and update UI accordingly
        function checkLoginStatus() {
            const sessionId = localStorage.getItem('sessionId');
            const checkoutBtn = document.querySelector('.checkout-btn');
            
            if (!sessionId) {
                // User is not logged in - make button redirect to login
                checkoutBtn.textContent = 'Login to Place Order';
                checkoutBtn.style.backgroundColor = '#1a1a1a';
                checkoutBtn.style.cursor = 'pointer';
                checkoutBtn.disabled = false;
                
                // Remove existing click handler and add login redirect
                checkoutBtn.onclick = function() {
                    window.location.href = '/Login';
                };
            } else {
                // User is logged in - enable normal checkout
                checkoutBtn.textContent = 'Complete Order';
                checkoutBtn.style.backgroundColor = '#1a1a1a';
                checkoutBtn.style.cursor = 'pointer';
                checkoutBtn.disabled = false;
                
                // Restore original click handler
                checkoutBtn.onclick = function() {
                    completeOrder();
                };
            }
        }

        // Show error message
        function showError(message) {
            const errorMessage = document.getElementById('errorMessage');
            const errorText = errorMessage.querySelector('.error-text');
            errorText.textContent = message;
            errorMessage.style.display = 'block';

            // Auto-hide after 5 seconds
            setTimeout(() => {
                hideError();
            }, 5000);
        }

        // Hide error message
        function hideError() {
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.style.display = 'none';
        }

        // Show success message
        function showSuccessMessage(message) {
            // Create success message element if it doesn't exist
            let successMessage = document.getElementById('successMessage');
            if (!successMessage) {
                successMessage = document.createElement('div');
                successMessage.id = 'successMessage';
                successMessage.className = 'success-message';
                successMessage.innerHTML = `
                    <div class="success-content">
                        <span class="success-icon">‚úì</span>
                        <span class="success-text"></span>
                        <button class="success-close" onclick="hideSuccess()">√ó</button>
                    </div>
                `;
                document.querySelector('.checkout-page .container').insertBefore(successMessage, document.querySelector('.checkout-content'));
            }

            const successText = successMessage.querySelector('.success-text');
            successText.textContent = message;
            successMessage.style.display = 'block';

            // Auto-hide after 5 seconds
            setTimeout(() => {
                hideSuccess();
            }, 5000);
        }

        // Hide success message
        function hideSuccess() {
            const successMessage = document.getElementById('successMessage');
            if (successMessage) {
                successMessage.style.display = 'none';
            }
        }

        // Save order to database with quotation processing
        async function saveOrderToDatabase(order) {
            try {
                const sessionId = localStorage.getItem('sessionId');
                if (!sessionId) {
                    console.error('No session ID found');
                    showError('You must be logged in to place an order. Please log in and try again.');
                    return false;
                }

                // Convert cart items to order items with product IDs and prices
                const orderItems = order.items.map(item => ({
                    ProductId: parseInt(item.id),
                    Quantity: item.quantity,
                    UnitPrice: parseFloat(item.price) // Use the price from cart (already includes markup)
                }));

                // Get user data to get the actual customer ID
                const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                console.log('üîç Debug - sessionId:', sessionId);
                console.log('üîç Debug - userData:', userData);
                console.log('üîç Debug - userData.id:', userData.id);
                
                const customerId = userData.id || parseInt(sessionId);
                console.log('üîç Debug - Final CustomerId:', customerId);
                
                const orderRequest = {
                    CustomerId: customerId,
                    OrderItems: orderItems,
                    ShippingAddress: order.customerInfo.address,
                    Notes: `Payment Method: ${order.paymentMethod}`
                };

                console.log('Sending order to GadgetHub API for quotation processing:', orderRequest);

                const response = await fetch('https://localhost:7091/api/Order/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(orderRequest)
                });

                console.log('üì° API Response status:', response.status);

                if (!response.ok) {
                    console.error('‚ùå API call failed with status:', response.status);
                    const errorText = await response.text();
                    console.error('‚ùå Error response:', errorText);
                    
                    // Show user-friendly error message
                    showError('Order creation failed. Please try again or contact support if the problem persists.');
                    return false;
                }

                const result = await response.json();
                console.log('üì• API Response data:', result);

                if (result.orderNumber) {
                    console.log('‚úÖ Order processed successfully with quotations:', result);
                    // Update the order with the actual order number from API
                    order.orderNumber = result.orderNumber;
                    order.status = result.status || 'Confirmed';
                    return true;
                } else {
                    console.error('‚ùå Failed to process order:', result);
                    return false;
                }
            } catch (error) {
                console.error('Error processing order with quotations:', error);
                showError('An unexpected error occurred while creating your order. Please try again.');
                return false;
            }
        }

        // Complete order function
        async function completeOrder() {
            console.log('=== COMPLETING ORDER ===');

            // Check if admin is logged in
            if (isAdminLoggedIn()) {
                showError('Admin users cannot place orders. Please log out and use a customer account to place orders.');
                return;
            }

            // Validate form
            const shippingForm = document.getElementById('shippingForm');
            if (!shippingForm.checkValidity()) {
                showError('Please fill in all required fields');
                return;
            }

            // Get payment method
            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked');
            if (!paymentMethod) {
                showError('Please select a payment method');
                return;
            }

            // Get form data
            const formData = new FormData(shippingForm);
            const shippingInfo = Object.fromEntries(formData);

            // Check if cart has items
            if (currentCartItems.length === 0) {
                showError('Your cart is empty!');
                return;
            }

            // Ensure totals are calculated before creating order
            calculateTotals();
            console.log('Current totals before order creation:', currentTotals);

            const order = {
                orderNumber: 'ORD-' + Date.now(),
                date: new Date().toISOString(),
                status: 'pending',
                paymentMethod: paymentMethod.value,
                customerInfo: {
                    firstName: shippingInfo.firstName,
                    lastName: shippingInfo.lastName,
                    email: shippingInfo.email,
                    phone: shippingInfo.phone,
                    address: shippingInfo.address,
                    city: shippingInfo.city,
                    country: shippingInfo.country
                },
                items: currentCartItems.map(item => ({
                    id: String(item.id),
                    name: item.name,
                    price: item.price,
                    quantity: item.quantity,
                    image: item.image,
                    distributorName: item.distributorName
                })),
                subtotal: currentTotals.subtotal,
                shipping: currentTotals.shipping,
                tax: currentTotals.tax,
                total: currentTotals.total
            };

            console.log('Order created:', order);

            // Save order to database via API
            const databaseSaved = await saveOrderToDatabase(order);
            
            if (databaseSaved) {
                console.log('‚úÖ Order saved to database successfully');
            } else {
                console.log('‚ö†Ô∏è Order saved to localStorage only (database save failed)');
            }

            // Also save to localStorage for immediate display
            const orderHistory = JSON.parse(localStorage.getItem('orderHistory')) || [];
            orderHistory.unshift(order);
            localStorage.setItem('orderHistory', JSON.stringify(orderHistory));

            // Clear cart
            localStorage.removeItem('cartItems');
            localStorage.removeItem('cartTotals');

            // Set flag to refresh dashboard when returning
            localStorage.setItem('orderPlaced', 'true');

            // Show success message
            showOrderSuccess(order);
        }

        // Show order success message
        function showOrderSuccess(order) {
            console.log('Showing order success message for order:', order);
            console.log('Order total value:', order.total);
            console.log('Order total type:', typeof order.total);
            console.log('Order items:', order.items);
            
            // Ensure order has required properties
            if (!order || typeof order !== 'object') {
                console.error('Invalid order object:', order);
                showSuccessMessage('Order placed successfully, but there was an issue displaying details.');
                return;
            }

            // Hide the checkout form
            document.querySelector('.checkout-content').style.display = 'none';

            // Create success section
            const successSection = document.createElement('div');
            successSection.className = 'order-success-section';
            successSection.innerHTML = `
                <div class="success-container">
                    <div class="success-header">
                        <h2 class="success-title">Order Placed Successfully!</h2>
                        <p class="success-message">Thank you for your purchase. Your order has been confirmed.</p>
                    </div>

                    <div class="order-summary-card">
                        <h3>Order Summary</h3>
                        <div class="order-details">
                            <div class="order-info">
                                <p><strong>Order Number:</strong> ${order.orderNumber || 'N/A'}</p>
                                <p><strong>Order Date:</strong> ${order.date ? new Date(order.date).toLocaleDateString() : new Date().toLocaleDateString()}</p>
                                <p><strong>Payment Method:</strong> ${getPaymentMethodName(order.paymentMethod) || 'N/A'}</p>
                                <p><strong>Total Amount:</strong> LKR ${(order.total || 0).toLocaleString()}</p>
                            </div>
                        </div>

                        <div class="order-items-summary">
                            <h4>Items Ordered:</h4>
                            ${(order.items || []).map(item => `
                                <div class="summary-item">
                                    <span>${item.name || 'Unknown Item'} x${item.quantity || 0}</span>
                                    <span>LKR ${((item.price || 0) * (item.quantity || 0)).toLocaleString()}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="next-steps">
                        <h3>What's Next?</h3>
                        <div class="steps-grid">
                            <div class="step">
                                <div class="step-content">
                                    <h4>Confirmation Email</h4>
                                    <p>You'll receive an order confirmation email shortly</p>
                                </div>
                            </div>
                            <div class="step">
                                <div class="step-content">
                                    <h4>Order Processing</h4>
                                    <p>We'll prepare your order for shipment</p>
                                </div>
                            </div>
                            <div class="step">
                                <div class="step-content">
                                    <h4>Delivery</h4>
                                    <p>Your order will be delivered to your address</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="success-actions">
                        <button class="btn-primary" onclick="window.location.href='/Dashboard'">View Order History</button>
                        <button class="btn-secondary" onclick="window.location.href='/Products'">Continue Shopping</button>
                    </div>
                </div>
            `;

            // Insert success section
            document.querySelector('.checkout-page .container').appendChild(successSection);
        }

        // Get payment method display name
        function getPaymentMethodName(method) {
            const methods = {
                'cashOnDelivery': 'Cash on Delivery'
            };
            return methods[method] || 'Cash on Delivery';
        }
    </script>

    <script>
        // Authentication and profile management
        function updateProfileIcon() {
            const userProfileNav = document.getElementById('userProfileNav');
            const adminProfileNav = document.getElementById('adminProfileNav');
            const loginLink = document.getElementById('loginLink');
            
            // Check if user is logged in
            const sessionId = localStorage.getItem('sessionId');
            const adminSession = localStorage.getItem('adminSession');
            
            if (adminSession) {
                // Admin is logged in
                loginLink.style.display = 'none';
                userProfileNav.style.display = 'none';
                adminProfileNav.style.display = 'flex';
                
                // Update admin avatar
                const adminUser = JSON.parse(localStorage.getItem('adminUser')) || {};
                const adminName = adminUser.name || 'Admin';
                const initials = adminName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                document.getElementById('adminAvatarInitials').textContent = initials;
                
            } else if (sessionId) {
                // Regular user is logged in
                loginLink.style.display = 'none';
                adminProfileNav.style.display = 'none';
                userProfileNav.style.display = 'flex';
                
                // Update user avatar
                const user = JSON.parse(localStorage.getItem('user')) || {};
                const userName = user.name || 'User';
                const initials = userName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                document.getElementById('avatarInitials').textContent = initials;
                
            } else {
                // No one is logged in
                userProfileNav.style.display = 'none';
                adminProfileNav.style.display = 'none';
                loginLink.style.display = 'block';
            }
        }

        // Initialize profile icon on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateProfileIcon();
        });
    </script>
</body>
</html>


